<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestor de Tareas</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="title-group">
        <h1><span class="title-icon">üìã</span><span>Mis Tareas</span></h1>
        <p>Organiza tus pendientes diarios con una vista clara y sencilla.</p>
      </div>
      <div class="badge-counter" id="badgeCantidad">0 tareas</div>
    </header>

    <section class="form-row">
      <input id="nuevaTarea" type="text" placeholder="Escribe una tarea clara y espec√≠fica">
      <input id="fechaTarea" type="date">
      <button class="btn-primary" onclick="agregarOActualizar()">üíæ Guardar</button>
      <button class="btn-secondary" onclick="cancelarEdicion()">Cancelar</button>
    </section>

    <div id="mensaje"></div>

    <div class="lista-wrapper">
      <ul id="lista"></ul>
    </div>
  </div>

  <script>
    const API = "http://localhost:8000/tareas";
    let tareaEnEdicion = null;

    function actualizarBadge(cantidad) {
      const badge = document.getElementById("badgeCantidad");
      badge.textContent = cantidad === 1 ? "1 tarea" : cantidad + " tareas";
    }

    async function cargar() {
      const res = await fetch(API);
      const data = await res.json();
      const lista = document.getElementById("lista");
      lista.innerHTML = "";
      data.forEach(t => {
        const estadoClase = t.completada ? "estado-completa" : "estado-pendiente";
        const estadoTexto = t.completada ? "Completada" : "Pendiente";

        lista.innerHTML += `
          <li>
            <div class="tarea-main">
              <div class="tarea-texto">
                <span>${t.texto}</span>
                <span class="estado ${estadoClase}">${estadoTexto}</span>
              </div>
              <div class="tarea-fecha">üìÖ ${t.fecha}</div>
            </div>
            <div class="acciones">
              <button class="btn-ghost" onclick="marcarCompletada(${t.id}, ${!t.completada})">
                ${t.completada ? "Marcar pendiente" : "Marcar completada"}
              </button>
              <button class="btn-ghost" onclick="editar(${t.id}, '${t.texto.replace(/'/g, "\\'")}', '${t.fecha}')">
                ‚úèÔ∏è Editar
              </button>
              <button class="btn-danger" onclick="eliminar(${t.id})">
                üóë Eliminar
              </button>
            </div>
          </li>`;
      });
      actualizarBadge(data.length);
    }

    async function agregarOActualizar() {
      const texto = document.getElementById("nuevaTarea").value;
      const fecha = document.getElementById("fechaTarea").value || new Date().toISOString().split("T")[0];
      const mensaje = document.getElementById("mensaje");
      mensaje.className = "";

      if (!texto.trim()) {
        mensaje.className = "mensaje-error";
        mensaje.textContent = "La tarea no puede estar vac√≠a.";
        return;
      }

      try {
        if (tareaEnEdicion) {
          const res = await fetch(API + "/" + tareaEnEdicion, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ texto, fecha })
          });
          if (!res.ok) throw new Error();
          mensaje.className = "mensaje-ok";
          mensaje.textContent = "Tarea actualizada.";
        } else {
          const res = await fetch(API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ texto, fecha })
          });
          if (!res.ok) throw new Error();
          mensaje.className = "mensaje-ok";
          mensaje.textContent = "Tarea agregada.";
        }
      } catch {
        mensaje.className = "mensaje-error";
        mensaje.textContent = "Error al guardar la tarea.";
      }

      document.getElementById("nuevaTarea").value = "";
      document.getElementById("fechaTarea").value = "";
      tareaEnEdicion = null;
      cargar();
    }

    function editar(id, texto, fecha) {
      tareaEnEdicion = id;
      document.getElementById("nuevaTarea").value = texto;
      document.getElementById("fechaTarea").value = fecha;
      const mensaje = document.getElementById("mensaje");
      mensaje.className = "";
      mensaje.textContent = "Editando tarea " + id;
    }

    function cancelarEdicion() {
      tareaEnEdicion = null;
      document.getElementById("nuevaTarea").value = "";
      document.getElementById("fechaTarea").value = "";
      const mensaje = document.getElementById("mensaje");
      mensaje.className = "";
      mensaje.textContent = "";
    }

    async function eliminar(id) {
      await fetch(API + "/" + id, { method: "DELETE" });
      cargar();
    }

    async function marcarCompletada(id, estado) {
      await fetch(API + "/" + id, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ completada: estado })
      });
      cargar();
    }

    cargar();
  </script>
</body>
</html>